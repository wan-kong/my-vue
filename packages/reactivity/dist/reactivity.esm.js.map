{
  "version": 3,
  "sources": ["../src/system.ts", "../src/effect.ts", "../src/ref.ts", "../../shared/src/index.ts", "../src/reactive.ts"],
  "sourcesContent": ["export type Dependency = {\r\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n  subs: Link | undefined;\r\n  //   \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n  subsTail: Link | undefined;\r\n};\r\n\r\n/**\r\n * \u8BA2\u9605\u8005\r\n * \u76EE\u524D\u662F\u53EA\u6709 effect\r\n */\r\nexport type Sub = {\r\n  /**\r\n   * \u5F53\u524D\u662F\u5426\u6B63\u5728\u6536\u96C6\u4F9D\u8D56?\r\n   * \u9632\u6B62\r\n   * effect(()=>{\r\n   *  console.log(count.value++)\r\n   * })\r\n   * \u8FD9\u79CD\u6B7B\u5FAA\u73AF\r\n   */\r\n  tracking: boolean;\r\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n  deps: Link | undefined;\r\n  //   \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n  depsTail: Link | undefined;\r\n};\r\n\r\nexport type Link = {\r\n  //   \u8BA2\u9605\u8005\r\n  sub: Sub;\r\n  preSub: Link | undefined;\r\n  nextSub: Link | undefined;\r\n  //   \u4F9D\u8D56\u9879\r\n  dep: Dependency;\r\n  nextDep: Link | undefined;\r\n};\r\n\r\n/**\r\n * \u4FDD\u5B58\u5DF2\u7ECF\u88AB\u6E05\u7406\u7684\u8282\u70B9\r\n */\r\nlet linkPool: Link;\r\n\r\n/**\r\n * \u94FE\u63A5\u94FE\u8868\u5173\u7CFB\r\n * @param dep\r\n * @param sub\r\n */\r\nexport function link(dep: Dependency, sub: Sub) {\r\n  const currentDep = sub.depsTail;\r\n  //   \u5C1D\u8BD5\u590D\u7528\u4F9D\u8D56\r\n  //   \u5982\u679C\u5934\u8282\u70B9\u6709\uFF0C\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u5C1D\u8BD5\u590D\u7528\u5934\u8282\u70B9\r\n  //   \u5982\u679C\u5C3E\u8282\u70B9\u8FD8\u6709nextDep,\u5C1D\u8BD5\u590D\u7528nextDep\r\n  const nextDep = currentDep === undefined ? sub.deps : sub.depsTail.nextDep;\r\n  if (nextDep && nextDep.dep === dep) {\r\n    sub.depsTail = nextDep;\r\n    return;\r\n  }\r\n  let newLink: Link;\r\n  /**\r\n   * \u5982\u679ClinkPool \u6709\uFF0C\u5219\u590D\u7528\u4E00\u4E0B\u3002\r\n   * \u6CA1\u6709\u5219\u521B\u5EFA\u65B0\u7684\u3002\r\n   */\r\n  if (linkPool) {\r\n    newLink = linkPool;\r\n    linkPool = linkPool.nextDep;\r\n    newLink.nextDep = nextDep;\r\n    newLink.dep = dep;\r\n    newLink.sub = sub;\r\n  } else {\r\n    newLink = {\r\n      sub,\r\n      preSub: undefined,\r\n      nextSub: undefined,\r\n      dep,\r\n      nextDep,\r\n    };\r\n  }\r\n  /**\r\n   * \u5C3E\u8282\u70B9\u6709\uFF0C\u8FD9\u5411\u5C3E\u8282\u70B9\u8FFD\u52A0\uFF0C\u5426\u5219\u5C31\u662F\u5934\u8282\u70B9\r\n   * \u8BA2\u9605\u8005\u7684\u53CC\u5411\u94FE\u8868\u63D2\u5165\r\n   */\r\n  if (dep.subsTail) {\r\n    dep.subsTail.nextSub = newLink;\r\n    newLink.preSub = dep.subsTail;\r\n    dep.subsTail = newLink;\r\n  } else {\r\n    dep.subs = newLink;\r\n    dep.subsTail = newLink;\r\n  }\r\n\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u7684\u94FE\u8868 (\u5355\u94FE\u8868)\r\n   */\r\n  if (sub.depsTail) {\r\n    sub.depsTail.nextDep = newLink;\r\n    sub.depsTail = newLink;\r\n  } else {\r\n    sub.deps = newLink;\r\n    sub.depsTail = newLink;\r\n  }\r\n}\r\n\r\n/**\r\n * \u89E6\u53D1\u4F9D\u8D56\u66F4\u65B0\r\n * @param subs\r\n *\r\n */\r\nexport function propagate(subs: Link) {\r\n  let link = subs;\r\n  const queuedEffect = [];\r\n  while (link) {\r\n    const sub = link.sub;\r\n    if (!sub.tracking) {\r\n      queuedEffect.push(sub);\r\n    }\r\n    link = link.nextSub;\r\n  }\r\n  queuedEffect.forEach(effect => effect.notify());\r\n}\r\n\r\n/**\r\n * \u5F00\u59CB\u8FFD\u8E2A\u4F9D\u8D56\r\n * \u5C06\u5C3E\u8282\u70B9\u65AD\u5F00\u8BBE\u7F6E\u4E3A undefined\r\n * @param sub\r\n */\r\nexport function startTracker(sub: Sub) {\r\n  sub.tracking = true;\r\n  sub.depsTail = undefined;\r\n}\r\n\r\nexport function endTracker(sub: Sub) {\r\n  sub.tracking = false;\r\n  const depsTail = sub.depsTail;\r\n  if (depsTail) {\r\n    if (depsTail.nextDep) {\r\n      clearTracking(depsTail.nextDep);\r\n      depsTail.nextDep = undefined;\r\n    }\r\n  } else if (sub.deps) {\r\n    clearTracking(sub.deps);\r\n    sub.deps = undefined;\r\n  }\r\n}\r\n\r\nexport function clearTracking(link: Link) {\r\n  while (link) {\r\n    const { preSub, nextDep, nextSub, dep } = link;\r\n\r\n    /**\r\n     * \u5982\u679CpreSub\u6709\uFF0C\u90A3\u5C31\u62FFpreSub\u7684nextSub\u8BBE\u7F6E\u4E3A link.nextSub;\r\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u90A3\u5C31\u662F\u5934\u8282\u70B9\uFF0C\u5C06dep.subs \u6307\u5411link.nextSub\r\n     */\r\n    if (preSub) {\r\n      preSub.nextSub = nextSub;\r\n      link.nextSub = undefined;\r\n    } else {\r\n      dep.subs = nextSub;\r\n    }\r\n\r\n    /**\r\n     * \u5982\u679CnextSub\u6709\uFF0C\u5C06nextSub\u7684preSub \u6307\u5411 link.preSub;\r\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u90A3\u5C31\u662F\u5C3E\u8282\u70B9\uFF0C\u76F4\u63A5\u79FB\u52A8dep\u7684\u5C3E\u6307\u9488\u5230preSub\r\n     */\r\n    if (nextSub) {\r\n      nextSub.preSub = preSub;\r\n      link.preSub = undefined;\r\n    } else {\r\n      dep.subsTail = preSub;\r\n    }\r\n    /**\r\n     * \u65AD\u5F00\u5173\u8054\u5173\u7CFB\r\n     */\r\n    link.dep = link.sub = undefined;\r\n    link.nextDep = linkPool;\r\n    /**\r\n     * \u5C06\u4E0D\u7528\u7684\u8282\u70B9\u7559\u7ED9linkPool\u53BB\u590D\u7528\r\n     * \u76F8\u5F53\u4E8E\u94FE\u8868\u4E0A\u8FD8\u662F\u6709\u8FD9\u4E2A\u7684\u3002\u4F46\u5177\u4F53\u6307\u5411\u4EC0\u4E48\uFF0C\u8981\u770B\u521B\u5EFA\u7684\u65F6\u5019\u7684\u91CD\u65B0\u8D4B\u503C\r\n     */\r\n    linkPool = link;\r\n    link = nextDep;\r\n  }\r\n}\r\n", "// \u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684effct\r\n\r\nimport { endTracker, Link, startTracker, Sub } from './system';\r\n\r\nexport let activeSub: Sub;\r\n\r\nexport class ReactiveEffect implements Sub {\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\r\n   */\r\n  deps: Link | undefined;\r\n  depsTail: Link | undefined;\r\n  /**\r\n   * \u5F53\u524D\u662F\u5426\u6B63\u5728\u6536\u96C6\u4F9D\u8D56?\r\n   * \u9632\u6B62\r\n   * effect(()=>{\r\n   *  console.log(count.value++)\r\n   * })\r\n   * \u8FD9\u79CD\u6B7B\u5FAA\u73AF\r\n   */\r\n  tracking: boolean;\r\n\r\n  constructor(public fn) {}\r\n\r\n  run() {\r\n    const preSub = activeSub;\r\n    activeSub = this;\r\n    startTracker(this);\r\n    try {\r\n      return this.fn();\r\n    } finally {\r\n      endTracker(this);\r\n      activeSub = preSub;\r\n    }\r\n  }\r\n  /**\r\n   * \u901A\u77E5\u66F4\u65B0\r\n   */\r\n  notify() {\r\n    this.schedular();\r\n  }\r\n\r\n  /**\r\n   * \u9ED8\u8BA4\u8C03\u7528run\uFF0C\u5982\u679C\u4F20\u5165\u4E86schedular\uFF0C\u5219\u4F1A\u88AB\u8986\u76D6\u4E3A\u4F20\u5165\u7684schedular\r\n   */\r\n  schedular() {\r\n    this.run();\r\n  }\r\n}\r\n\r\n/**\r\n *\r\n * @param {Function} fn\r\n * @param {Object} options\r\n * @param {Function} options.schedular\r\n * @returns\r\n */\r\nexport function effect(\r\n  fn: Function,\r\n  options: {\r\n    schedular?: Function;\r\n  },\r\n) {\r\n  const e = new ReactiveEffect(fn);\r\n  Object.assign(e, options);\r\n  e.run();\r\n  const runner = () => e.run();\r\n  runner.effect = e;\r\n  return runner;\r\n}\r\n", "import { activeSub } from './effect';\r\nimport { Link, propagate, link, Sub, Dependency } from './system';\r\n\r\nenum ReactiveFlags {\r\n  IS_REF = '__v_isRef',\r\n}\r\n\r\nclass RefImpl<T> implements Dependency {\r\n  _value;\r\n\r\n  [ReactiveFlags.IS_REF]: true;\r\n\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n   */\r\n  subs: Link;\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n   */\r\n  subsTail: Link;\r\n\r\n  constructor(value: T) {\r\n    this._value = value;\r\n  }\r\n  get value() {\r\n    // \u6536\u96C6\u4F9D\u8D56\r\n    trackRef(this, activeSub);\r\n    return this._value;\r\n  }\r\n  set value(newValue) {\r\n    this._value = newValue;\r\n    triggerRef(this);\r\n  }\r\n}\r\n\r\n/**\r\n * \u4F9D\u8D56\u6536\u96C6\r\n * @param dep\r\n */\r\nexport function trackRef(dep: Dependency, sub: Sub) {\r\n  if (sub) {\r\n    link(dep, sub);\r\n  }\r\n}\r\n\r\n/**\r\n * \u89E6\u53D1\u4F9D\u8D56\u66F4\u65B0\r\n * @param dep\r\n */\r\nexport function triggerRef(dep: Dependency) {\r\n  if (dep.subs) {\r\n    propagate(dep.subs);\r\n  }\r\n}\r\n\r\nexport function ref<T>(value: T) {\r\n  return new RefImpl(value);\r\n}\r\n", "export const isObject = obj => {\r\n  return typeof obj === 'object' && obj !== null;\r\n};\r\n", "import { isObject } from '@my-vue/shared';\r\nimport { Dependency, link, Link, propagate } from './system';\r\nimport { activeSub } from './effect';\r\n\r\nexport function reactive(target: Object) {\r\n  return createReactiveObject(target);\r\n}\r\n\r\nfunction createReactiveObject<T extends Object>(target: T) {\r\n  if (!isObject(target)) {\r\n    throw new Error('you should set a object to reactive');\r\n  }\r\n\r\n  const proxy = new Proxy(target, {\r\n    get(target, key, receiver) {\r\n      // \u6536\u96C6\u4F9D\u8D56\r\n      track(target, key);\r\n      return Reflect.get(target, key);\r\n    },\r\n    set(target, key, newValue, receiver) {\r\n      // \u89E6\u53D1\u66F4\u65B0\r\n      //   \u5148\u66F4\u65B0\u8D4B\u503C\r\n      const res = Reflect.set(target, key, newValue);\r\n      //   \u89E6\u53D1\u66F4\u65B0\u51FD\u6570\r\n      trigger(target, key);\r\n      return res;\r\n    },\r\n  });\r\n\r\n  return proxy;\r\n}\r\n\r\nconst targetMap = new WeakMap<Object, Map<keyof Object, Dep>>();\r\n\r\nfunction track(target, key) {\r\n  if (!activeSub) return;\r\n  let depsMap = targetMap.get(target);\r\n  if (!depsMap) {\r\n    depsMap = new Map();\r\n    targetMap.set(target, depsMap);\r\n  }\r\n  let dep = depsMap.get(key);\r\n  if (!dep) {\r\n    dep = new Dep();\r\n    depsMap.set(key, dep);\r\n  }\r\n  link(dep, activeSub);\r\n}\r\n\r\nfunction trigger(target, key) {\r\n  const depsMap = targetMap.get(target);\r\n  if (!depsMap) return;\r\n  const deps = depsMap.get(key);\r\n  if (!deps) return;\r\n  propagate(deps.subs);\r\n}\r\n\r\nclass Dep implements Dependency {\r\n  subs: Link;\r\n  subsTail: Link;\r\n}\r\n"],
  "mappings": "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",
  "names": ["link", "effect", "target"]
}
